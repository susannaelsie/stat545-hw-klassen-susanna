---
title: "hw04"
output: 
    html_document:
      keep_md: yes
      toc: yes
---

First I'll need to load the tidyverse and knitr packages:

```{r}
library(tidyverse)
library(knitr)
```


## Introducing my tasks for hw04

I have imported several data tables into my local environment, but want to create a new dataset to work with that will contain information from both. Specifically, I am interested in the various levels of off-farm paid work and on-farm capital in various Census Divisions (CD) in British Columbia (BC), particularly those with a high number of blueberry farms.

All of the data frames have values for each CD in BC, but they vary in their number of observations per CD (some have many as they are count data across various categories). All data frames have values for both 2011 and 2016. 

## 1. Re-shaping my data

I am going to perform a variation on Activity #2, using Stats Canada Agricultural Census Data instead of the Gapminder data. Note that I first need to save my newly imported dataset as an Rdata file (using ```save(Blueberry_Farms, file="Blueberry_Farms.RData")```), and then load it using the following chunk:

```{r}
load(file = "Blueberry_Farms.RData")
```


I need to do the same with the (1) Off-farm Work and (2) Total Farm Capital dataframes that I will use later on:

```{r}
load(file = "PaidNonFarmWork.RData")
load(file = "TotalFarmCapital.RData")
```



### 1.1 Using ```gather``` to make a longer dataframe

Currently, one of my dataframes has 2 variables (columns) for each year, and I'd like to re-shape it so that it has a single row per year (and one variable for number of "farms reporting blueberries").


```{r}
knitr::kable(Blueberry_Farms)
```

To re-shape this, I'll use the ```gather``` function. I'll also name this new table "bf", arrange the observations by CD_Region, select for the Census Division name, year, and number of blueberry farms.   

```{r}
bf <- Blueberry_Farms %>%
  gather(key = "year", value = "blueberry_farms", "2011":"2016") %>%
  arrange(CD_Region) %>%
  select(CD_Region, year, blueberry_farms) 
  knitr::kable(bf)
```

### 1.2 Make a plot comparing number of blueberry farms by region

While in the hw04 description activity 2 (re-shaping) involves plotting life expectancy in 2 countries to compare (using multiple years of data), here I only have 2 years of data, but am interested to compare multiple regions. Let's figure out which regions have the highest number of blueberry farms.

```{r}
bf %>% 
  arrange(blueberry_farms) # Need to integrate argument for descending order?
  knitr::kable(bf) # And figure out why when I add this the arrange function no longer works...
```


```{r}
bf %>%
  filter(CD_Region %in% c("Fraser Valley", "Greater Vancouver", "Capital", "Comox Valley")) %>%
  ggplot(aes(x = CD_Region, y = blueberry_farms)) +
  geom_col(aes(color=year), position = "dodge")
```

It is interesting to see from this plot that the four Census Divisions with highest number of blueberry farms have shown different trends from 2011 and 2016 -- with the Fraser Valley and the Comox Valley showing an increase, and the Capital and Greater Vancouver regions showing a decrease. 

### 1.3 Preparing additional dataframes

I'd also like to take a look at the extent of paid off-farm work in various different CDs. The dataframe for 'PaidNonFarmWork' also has columns for year, so I will again use ```gather``` so that these two dataframes are in the same format.


```{r}
ofw <- PaidNonFarmWork %>%
  gather(key = "year", value = "number_operators", "2011":"2016") %>%
  arrange(CD_Region) %>%
  select(CD_Region, Avg_Hrs_OffFarmWork, year, number_operators) 
  knitr::kable(ofw)
```

Now we have a row for each year of data, and I've defined this new dataframe 'ofw'. 

I'd like to define a single measure for each region to indicate the extent of off-farm work. I think that the proportion of farm operators that work 20+ hours a week off of the farm should be a good measure, so I have some additional re-shaping to do...

First, I am going to ```spread``` the data so that I can have the number of operators in each 'bin' as variables instead of observations, as I think it will be easier to work with once in that format. 

I also want to create a new variable for the proportion of farm operators in each region that work 20+ hours off the farm (PropOp_20).

-- how to sum [some] column values in a new variable??? Try dcast( identifier, place where vales are stored, fun.aggregate = sum) #fun aggregate takes more than oen value and spits out a single value

Use group_by and summarize after re-shaping?


```{r}
ofw_wide <- ofw %>%
  spread(Avg_Hrs_OffFarmWork, number_operators) ##add a mutate in here to sum 3 columns across the observation?
```






I'd also like to take a look at values of on-farm capital in various different CDs. The dataframe for 'Total On-farm Capital' also has columns for year, so I will once again use ```gather``` so that these two dataframes are in the same format.

```{r}
fc <- TotalFarmCapital %>%
  gather(key = "year", value = "number_farms", "2011":"2016") %>%
  arrange(CD_Region) %>%
  select(CD_Region, Farms_TotFarmCap, year, number_farms) 
  knitr::kable(fc)
```

Now we have a row for each year of data, and I've defined this new dataframe 'fc'. However, I'd like to define a single measure for each region to indicate the level of farm capital in the region. I think that the proportion of farms in each region with 


Make plots using faceting - geom_column and faceting for each region (x = categories of off-farm work and/or total farm capital). do not use scale because i want to compare regions (same units)

## 2. Joining two dataframes

Now that I have re-shaped two dataframes, I will join them! Because I should have the same observations by region and year, I simply want to combine the columns/variables. As such, I will use the ```full_join``` function.

```{r}
Blue_off_farm <- left_join(ofw_wide, bf, by = "CD_Region", "year")
knitr::kable(Blue_off_farm)
```

Why am I getting duplicated values for each year? All 3 join functions come back with the same resut...


In order to test out a new join function, I'm going to try adding data about Total Farm Capital to this new Blueberry Farms and Off-farm Work dataframe. 

This dataframe is currently in the same format that the others were, with columns for years and different measures as row numbers. I am going to make a new dataframe with only values for 2016, and try combining these two to see what I get.

First, I'm going to drop the 2011 data from the Total Farm Capital dataframe

This is the code I tried to use but get an error:

TotFarmCap16 <- TotalFarmCapital %>%
  select(2016) %>%
knitr::kable(TotFarmCap16)
--> problem with numeric column/variable name?



Now I tried to set up piping to select for the one variable, "No off-farm work" (as a single measure that tells us about whether farm operators are able to sustain their business without off-farm income), but again I get an error message, presumably from the variable name having spaces. Can I fix with the rename function in dplyr? Or do I need to change it before importing the dataset (also easy..). This thread: https://stackoverflow.com/questions/21502465/replacement-for-rename-in-dplyr

Blue_off_farm %>%
  select(CD_Region, year, "No off-farm work", blueberry_farms)





This was pretty simple, so I'll also take a look at activity #3

## 3. Exploring ```Match``` and ```Merge```

match returns a vector of the positions of (first) matches of its first argument in its second.
