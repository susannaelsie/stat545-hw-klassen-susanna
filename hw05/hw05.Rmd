---
title: "hw05"
output: 
  html_document: 
    keep_md: yes
---

## 0. Pre-amble

I'm going to use both the gapminder dataset and a dataset from the Canadian Census of Agriculture to go through the exercises for hw05.

First I'll load all of the packages I'm going to need for this assignment in one tidy chunk of code (including <a href="https://github.com/karthik/wesanderson">a new colour palette</a>...)

```{r}
library("wesanderson")
library(gapminder)
library(tidyverse)
library(knitr)
options(knitr.table.format = 'markdown')
library(forcats)
library(readxl) #package already downloaded (bundled in the tidyverse package!) for reading excel files
library(RColorBrewer)
```


## 1. Factor Management

Starting with the gapminder dataset, I'll refresh my memory of what I'm working with here...

```{r}
gapminder
```


As I know this assignment works with factors, I've noted which variables are factors.

I want to drop observations for Oceania, and then drop the unused factor levels (left by Oceania's absense). First let me take a look at the number of factor levels (and associated number of observations for each) there are for the variable ```Continent```:

### 1.1 Dropping Oceania from Gapminder

```{r}
nlevels(gapminder$continent) # total # levels for continent (factor)
fct_count(gapminder$continent) # number of obs per factor using forcats package
```


```{r}
gap_5 <- gapminder %>% 
  filter(!continent == "Oceania")
```

Now I'll use the forcats package to drop unused levels

```{r}
gap_5_dropped <- gap_5 %>% 
  droplevels()
nlevels(gap_5_dropped$continent)
```
 
 Checking to see if this worked...

```{r}
nlevels(gap_5_dropped$continent) # total # levels for continent (factor)
fct_count(gap_5_dropped$continent) # number of obs per factor using forcats package
```

Success!

### 1.2 Using factors in BC Agriculture data

Initially I was only going to bring in and take a look at these first two datasets on expensese and receipts(sales) on farms in the year 2006 (stored as an excel file in my working directory). However, once I got further along in the assignment I decided to bring in additional data for other years so that I have more to work with. Unfortnately, this data is not available in one excel file, but must be downloaded as individual files for each year (and sometimes for each variable). The readme.md file for this assignment has more description of each of these datasets. 

```{r}
exp_rec_86 <- read_excel("1986_exp_rec.xls")
exp_rec_91 <- read_excel("1991_exp_rec.xls")
exp96 <- read_excel("1996_exp.xls")
rec96 <- read_excel("1996_rec.xls")
exp_rec_2001 <- read_excel("2001_exp_rec.xls")
exp06 <- read_excel("2006_exp.xls")
rec06 <- read_excel("2006_rec.xls")
exp_rec_2011 <- read_excel("2011_exp_rec.xls")
```

These are somewhat large files (~2100 observations each and between 16 and 106 variables. So I'd like to zoom in on the measures and regions I am most interested in (see <a href="">my README.md file</a> for more details.

#### 1.2.1 Prepping the data

I'll use a combination of select and filter to create new dataframes with the information I care to look at (variables in the readme file and the Census Agricultural Regions (CARs) in BC), and then I'll do some work with factors. 

```{r}
exp_rec_86_BC <- exp_rec_86 %>% # note different column names for many of the datasets (though same variables)
  select(AREAID, PROV, CAR, CD, AREANAME, TOTEXP, SALES95, NTOTEXP) %>% #leaving enough information for future analyses
  filter(AREAID %in% c("590100000", "590200000", "590300000", "590400000", "590500000", "590600000", "590700000", "590800000")) # note that region names and numbers changed in 2001, so using AREAIDs here

exp_rec_91_BC <- exp_rec_91 %>% # 
  select(AREAID, PROV, CAR, CD, AREANAME, TOTEXP, SALES95, NTOTEXP) %>% 
  filter(AREAID %in% c("590100000", "590200000", "590300000", "590400000", "590500000", "590600000", "590700000", "590800000")) 

rec96_BC <- rec96 %>% 
  select(AREAID, PROV, CAR, CD, AREANAME, SALES95) %>% 
  filter(AREAID %in% c("590100000", "590200000", "590300000", "590400000", "590500000", "590600000", "590700000", "590800000")) 

exp96_BC <- exp96 %>% 
  select(AREAID, PROV, CAR, CD, AREANAME, TOTEXP, NTOTEXP) %>% 
  filter(AREAID %in% c("590100000", "590200000", "590300000", "590400000", "590500000", "590600000", "590700000", "590800000")) 

exp_rec_2001_BC <- exp_rec_2001 %>% 
  select(PROV, CAR2, CD, `GEO NAMES`, totexp, ntotexp, salesxfp) %>% 
  filter(CD == 0, `GEO NAMES` %in% c("Vancouver Island-Coast", "Lower Mainland-Southwest", "Thompson-Okanagan", "Kootenay", "Cariboo", "North Coast", "Nechako", "Peace River"))

rec06_BC <- rec06 %>% 
  select(HDPROV, AGOPCAR, CENSUSD, AREANAME, VAL_SALESXFP) %>% 
  filter(CENSUSD == 0, AREANAME %in% c("Vancouver Island-Coast", "Lower Mainland-Southwest", "Thompson-Okanagan", "Kootenay", "Cariboo", "North Coast", "Nechako", "Peace River"))

exp06_BC <- exp06 %>%  
  select(HDPROV, AGOPCAR, CENSUSD, AREANAME, NTOTEXP, TOTEXP) %>% 
  filter(CENSUSD == 0, AREANAME %in% c("Vancouver Island-Coast", "Lower Mainland-Southwest", "Thompson-Okanagan", "Kootenay", "Cariboo", "North Coast", "Nechako", "Peace River"))

exp_rec_2011_BC <- exp_rec_2011 %>% 
  select(HDPROV, AGOPCAR, CENSUSD, AREANAME, VAL_SALESXFP, NTOTEXP, TOTEXP) %>% 
  filter(HDPROV == 59, AGOPCAR %in% c("01", "02", "03", "04", "05", "06", "07", "08"), CENSUSD == "00") # once again need to use different filter because areas are named differently
```

Great! Much more manageable. Now I'll remove the larger dataframes, which I won't be needing anymore. 

```{r}
rm(exp_rec_2001, exp_rec_2011, exp_rec_86, exp_rec_91, exp06, rec06, exp96, rec96)
```


Now I will take look at the new [smaller] dataframes to see how the region names or region identifier are stored /what types of objects they are. I'll just check a subset of the dataframes to see what I am working with. 

```{r}
str(exp_rec_86_BC)
str(exp_rec_91_BC)
str(exp06_BC)
```

Oh boy - all sorts of fun going on there. 

- For the **1986** data, AREAID is a character, AREANAME is a character, TOTEXP is also a character (will have to change), whereas the other 2 measures/variables are numeric.
- For the **1991** data, same thing.
- For the **2006** data, AREANAME is a character, AGOPCAR is numeric, and TOTEXP is also a character (will have to change). 

So I know that I will have some conversions to do. I'll get those out of the way now.

#### 1.2.2 Changing ```things```

I'm going to start with a pilot test for converting one variable to a factor. 

```{r}
rec06_BC$AGOPCAR <- as_factor(as.character(rec06_BC$AGOPCAR)) 
```

Now I'd like to see if I can rename the factor with the CAR names...

```{r}
levels(rec06_BC$AGOPCAR)<-c("Vancouver Island-Coast", "Lower Mainland-Southwest", "Thompson-Okanagan", "Kootenay", "Cariboo", "North Coast", "Nechako", "Peace River")
```

Success (and I can see that the names are accurate because I still have the AREANAME column). 

Now I'd like to do the same with the other dataframes, and ensure they have a common factor name and level  for Census Agricultural Region (as well as a unique identifier) so that I can join them later. I will go through the following process for each dataframe before merging them:
1. Create/change variable to include unique number for each CAR region (and ensure these are consistent with numbering used post 2001, not prior to)
2. Convert variable types as needed 
3. Drop unused variables
4. Add a column for year

1986 data:

```{r}
exp_rec_86_BC$CAR <- as_factor(as.character(exp_rec_86_BC$CAR)) #Re-naming to simplify names
  levels(exp_rec_86_BC$CAR)<-c("Kootenay", "Okanagan", "Thompson", "Mainland", "Island", "Cariboo", "Omineca", "Peace") 
  
ord_86 <-exp_rec_86_BC$CAR %>% #Re-ordering (even though regions boundaries are different) to follow similar order to 2001 onwards
  fct_relevel("Island", "Mainland", "Okanagan", "Thompson", "Kootenay", "Cariboo", "Omineca", "Peace") %>% 
  levels()

exp_rec_86_BC$TOTEXP <- as.numeric(exp_rec_86_BC$TOTEXP) # change to numeric
str(exp_rec_86_BC) # check

exp_rec_86_BC %>% 
  mutate(YEAR = 1986) %>% # adding new column for year
  select(AREAID, CAR, YEAR, NTOTEXP, TOTEXP, SALES95) %>% # dropping unused variables
  knitr::kable()

levels(exp_rec_86_BC$CAR)
```

1991 data:

```{r}
exp_rec_91_BC$CAR <- as_factor(as.character(exp_rec_91_BC$CAR)) #Re-naming to simplify names
  levels(exp_rec_91_BC$CAR)<-c("Kootenay", "Okanagan", "Thompson", "Mainland", "Island", "Cariboo", "Omineca", "Peace") 
  
exp_rec_91_BC$CAR %>% #Re-ordering (even though regions boundaries are different) to follow similar order to 2001 onwards
  fct_relevel("Island", "Mainland", "Okanagan", "Thompson", "Kootenay", "Cariboo", "Omineca", "Peace") %>% 
  levels()

exp_rec_91_BC$SALES95 <- as.numeric(exp_rec_91_BC$SALES95) # change to numeric
str(exp_rec_91_BC) #check

exp_rec_91_BC %>% 
  mutate(YEAR = 1991) %>% # adding new column for year
  select(AREAID, CAR, YEAR, NTOTEXP, TOTEXP, SALES95) %>% # dropping unused variables
  knitr::kable()
```

1996 Expenses data:

```{r}
exp96_BC$CAR <- as_factor(as.character(exp96_BC$CAR)) #Re-naming to simplify names
  levels(exp96_BC$CAR)<-c("Kootenay", "Okanagan", "Thompson", "Mainland", "Island", "Cariboo", "Omineca", "Peace") 
  
exp96_BC$CAR %>% #Re-ordering (even though regions boundaries are different) to follow similar order to 2001 onwards
  fct_relevel("Island", "Mainland", "Okanagan", "Thompson", "Kootenay", "Cariboo", "Omineca", "Peace") %>% 
  levels()

exp96_BC$TOTEXP <- as.numeric(exp96_BC$TOTEXP) # change to numeric
str(exp96_BC) #check

exp96_BC %>% 
  mutate(YEAR = 1996) %>% # adding new column for year
  select(AREAID, CAR, YEAR, NTOTEXP, TOTEXP) %>% # dropping unused variables
  knitr::kable()
```

1996 Receipts Data:


```{r}
rec96_BC$CAR <- as_factor(as.character(rec96_BC$CAR)) #Re-naming to simplify names
  levels(rec96_BC$CAR)<-c("Kootenay", "Okanagan", "Thompson", "Mainland", "Island", "Cariboo", "Omineca", "Peace") 
  
rec96_BC$CAR %>% #Re-ordering (even though regions boundaries are different) to follow similar order to 2001 onwards
  fct_relevel("Island", "Mainland", "Okanagan", "Thompson", "Kootenay", "Cariboo", "Omineca", "Peace") %>% 
  levels()

rec96_BC$SALES95 <- as.numeric(rec96_BC$SALES95) # change to numeric
str(rec96_BC) #check

rec96_BC %>% 
  mutate(YEAR = 1996) %>% # adding new column for year
  select(AREAID, CAR, YEAR, SALES95) # dropping unused variables
```


2006 data:

```{r}
exp06_BC$AGOPCAR <- as_factor(as.character(exp06_BC$AGOPCAR))
levels(exp06_BC$AGOPCAR)<-c("Vancouver Island-Coast", "Lower Mainland-Southwest", "Thompson-Okanagan", "Kootenay", "Cariboo", "North Coast", "Nechako", "Peace River")

```



```{r}

```





And now I'll join these two dataframes and drop unnecessary variables..

```{r}
rec_exp_06_BC <- left_join(exp06_BC, rec06_BC) %>% 
  select(HDPROV, AGOPCAR, TOTEXP, VAL_SALESXFP)
```

Now this is data has been 'wrangled' and is [nearly] ready for some plotting.


#### 1.2.3 Re-ordering the factors in a principled way

Check default ordering..
```{r}
rec_exp_06_BC$AGOPCAR %>% 
  levels()
```

I'd like to calculate the percentage of sales that are profit for each region as a summary statistic, then re-order the data based on this. However, I have realized that my variables of TOTEXP and VAL_SALESXFP are currently in the character format! Not going to work for these calculations. So first I'll convert these to numerical.

```{r}
rec_exp_06_BC$TOTEXP <- as.numeric(rec_exp_06_BC$TOTEXP) # Converting to numeric
str(rec_exp_06_BC$TOTEXP) # Checking to be sure it worked
rec_exp_06_BC$VAL_SALESXFP <- as.numeric(rec_exp_06_BC$VAL_SALESXFP)
str(rec_exp_06_BC$VAL_SALESXFP)
```

```{r}
fct_reorder(rec_exp_06_BC$AGOPCAR, rec_exp_06_BC$VAL_SALESXFP, .desc = TRUE) %>% 
  levels()
```

Now I will plot the total gross farm receipts (sales) by the ordered CARs. Only, the colour palette I have been dying to use only has 5 colours (wohn-wohn), so I am going to only plot 5 of the regions.

```{r}
rec_exp_06_BC %>% 
  filter(AGOPCAR %in% c("Lower Mainland-Southwest", "Thompson-Okanagan", "Vancouver Island-Coast", "Peace River", "Cariboo")) %>% 
  ggplot(aes(x = fct_reorder(AGOPCAR, VAL_SALESXFP, .desc = TRUE), y = TOTEXP)) +
  geom_col(aes(fill = AGOPCAR)) +
  labs(x="Census Agricultural Region", y="Total Farm Operating Expenses", title="Total Operating Expenses on Farms by Census Agricultural Region in B.C.") +
  scale_fill_manual(values = wes_palette("Cavalcanti")) + 
  theme(axis.title = element_text(size=14),
        plot.title = element_text(size=16, hjust = 0.5),
        legend.position = "right",
        legend.direction = "vertical",
        legend.title = element_text(size=12))
```

Success!

Now, to make sure I accomplish the tasks from the homework, I'll create a new variable (instead of a summary statistic) that takes into account both measures of sales and expenses ((expenses / sales) * 100).

```{r}
rec_exp_06_BC %>% 
  mutate(perc_exp =(TOTEXP/VAL_SALESXFP)*100) %>% 
  knitr::kable()
```

Now I'll re-order based on this new variable, and plot that...

```{r}
rec_exp_06_BC %>% 
  filter(AGOPCAR %in% c("Lower Mainland-Southwest", "Thompson-Okanagan", "Vancouver Island-Coast", "Peace River", "Cariboo", "Kootenay", "Nechako")) %>% 
  mutate(perc_exp = (TOTEXP/VAL_SALESXFP)*100) %>% 
  ggplot(aes(x = fct_reorder(AGOPCAR, perc_exp, .desc = TRUE), y = perc_exp)) +
  geom_col(aes(fill = AGOPCAR)) +
  labs(x="Census Agricultural Region", y="Operating Expenses as Percent of Farm Receipts", title="Expenses as a Percent of Farm Sales in B.C.") +
  scale_fill_manual(values = wes_palette("BottleRocket")) + 
  theme(axis.title = element_text(size=14),
        plot.title = element_text(size=16, hjust = 0.5),
        legend.position = "right",
        legend.direction = "vertical",
        legend.title = element_text(size=12))
```

I wasn't able to also order the legend.



## 2. Writing to file, Reading

I'm going to try writing the re-ordered dataframe to a csv file.


First I tried using the ```fct_reorder``` function and then piping that into the ```write_csv``` command, but that prompts an error message, I think because the ```fct_reorder``` doesn't re-order the whole dataframe. 


So instead, I found this other way to re-order by the dataframe using indexing:

```{r}
rec_exp_06_BC[order(rec_exp_06_BC$VAL_SALESXFP, decreasing = TRUE),] %>% # Keep columns the way they are but order the rows by Sales
  write_csv("rec_exp_06_BC.csv")
```

Now I'll bring it back in...

```{r}
read_csv("rec_exp_06_BC.csv")
```

While the csv file is still in the specified order, the AGOPCAR variable is now a character, once again. So some information has been lost.

## 3. Visualization Design


## 4. Writing figures to file



